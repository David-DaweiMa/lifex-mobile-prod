# AI Chat Setup Guide

This guide explains how to set up the AI-powered chat feature in the LifeX mobile app.

## Overview

The chat feature uses:
- **OpenAI API** (GPT-4o-mini) for AI responses
- **Supabase Edge Functions** to securely call OpenAI API
- **Conversation history** for context-aware responses
- **Follow-up questions** generated by AI

## Architecture

```
Mobile App (ChatScreen)
    ‚Üì
ChatService
    ‚Üì
Supabase Edge Function (chat)
    ‚Üì
OpenAI API (GPT-4o-mini)
```

## Setup Steps

### 1. Get OpenAI API Key

1. Go to [OpenAI Platform](https://platform.openai.com/)
2. Sign up or log in
3. Navigate to API Keys
4. Create a new API key
5. Copy the key (you won't be able to see it again!)

### 2. Configure Supabase Edge Function

The Edge Function is located at `supabase/functions/chat/index.ts`.

#### Deploy the Edge Function

```bash
# Install Supabase CLI if you haven't already
npm install -g supabase

# Login to Supabase
supabase login

# Link your project
supabase link --project-ref your-project-ref

# Deploy the chat function
supabase functions deploy chat

# Set the OpenAI API key as a secret
supabase secrets set OPENAI_API_KEY=your_openai_api_key_here
supabase secrets set OPENAI_MODEL=gpt-4o-mini
```

### 3. Configure Environment Variables

Update your `.env` file with the following:

```env
# Supabase Configuration
EXPO_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=your_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here

# OpenAI Configuration (for Edge Function - set via Supabase CLI)
# These are set as Supabase secrets, not in .env
# OPENAI_API_KEY=sk-...
# OPENAI_MODEL=gpt-4o-mini

# App Configuration
EXPO_PUBLIC_APP_NAME=LifeX
EXPO_PUBLIC_APP_VERSION=1.0.0
EXPO_PUBLIC_ENV=production
```

**‚ö†Ô∏è Important:** Never commit `.env` file with real API keys to Git!

### 4. Test the Integration

#### Enable AI API in Code

In `src/services/chatService.ts`, ensure:

```typescript
const USE_AI_API = true; // Toggle to switch between AI API and mock responses
```

#### Test in the App

1. Start the app: `npx expo start`
2. Navigate to the Chat screen
3. Send a message like "Best coffee shops in Auckland?"
4. You should receive an AI-generated response

#### Check Logs

Look for these console logs:
- ‚úÖ `AI Response received:` - AI API is working
- ‚ö†Ô∏è `Using mock response` - Falling back to mock data
- ‚ùå `AI API call failed` - There's an error

### 5. Monitor Usage

#### OpenAI Dashboard

Monitor your API usage at: https://platform.openai.com/usage

#### Supabase Edge Function Logs

```bash
# View function logs
supabase functions logs chat
```

## Features

### Context-Aware Conversations

The chat maintains conversation history (last 10 messages) to provide context-aware responses.

### Follow-Up Questions

After each response, the AI generates 3 relevant follow-up questions to guide the conversation.

### Fallback Mechanism

If the AI API fails:
1. The app catches the error
2. Falls back to mock responses
3. User experience remains uninterrupted

### Guest Limits

- **Guest users**: 5 messages per session
- **Signed-in users**: Unlimited messages

## Customization

### Adjust AI Behavior

Edit the system prompt in `supabase/functions/chat/index.ts`:

```typescript
const systemPrompt = `You are LifeX, an AI assistant helping people discover local services...`;
```

### Change AI Model

For better responses (higher cost):
```bash
supabase secrets set OPENAI_MODEL=gpt-4
```

For faster responses (lower cost):
```bash
supabase secrets set OPENAI_MODEL=gpt-3.5-turbo
```

### Adjust Response Length

In `supabase/functions/chat/index.ts`:

```typescript
body: JSON.stringify({
  model: openaiModel,
  messages,
  temperature: 0.7,
  max_tokens: 500,  // Increase for longer responses
  // ...
}),
```

## Troubleshooting

### Error: "OpenAI API Key not configured"

**Solution:** Deploy the Edge Function and set the secret:
```bash
supabase secrets set OPENAI_API_KEY=your_key_here
```

### Error: "Function not found"

**Solution:** Deploy the Edge Function:
```bash
supabase functions deploy chat
```

### Using Mock Responses Instead of AI

**Possible causes:**
1. `USE_AI_API = false` in `chatService.ts`
2. `EXPO_PUBLIC_SUPABASE_URL` not set in `.env`
3. Edge Function not deployed
4. OpenAI API key not set as Supabase secret

### Slow Responses

**Solutions:**
1. Switch to `gpt-3.5-turbo` for faster responses
2. Reduce `max_tokens` in Edge Function
3. Check your internet connection

## Cost Considerations

### OpenAI Pricing (as of 2024)

- **GPT-4o-mini**: ~$0.15 per 1M input tokens, ~$0.60 per 1M output tokens
- **GPT-3.5-turbo**: ~$0.50 per 1M tokens

### Estimated Costs

With gpt-4o-mini and average 100 tokens per response:
- 1,000 conversations ‚âà $0.08
- 10,000 conversations ‚âà $0.80
- 100,000 conversations ‚âà $8.00

### Cost Optimization

1. **Use GPT-4o-mini** instead of GPT-4 (much cheaper)
2. **Limit conversation history** (already set to last 10 messages)
3. **Set max_tokens** to reasonable values
4. **Implement rate limiting** for guest users (already done: 5 messages/session)

## Security

### API Key Protection

‚úÖ **Good practices in this implementation:**
- OpenAI API key stored in Supabase secrets (server-side)
- Never exposed to client app
- Edge Function handles all OpenAI API calls

‚ùå **Don't do:**
- Store OpenAI API key in `.env` (client-side)
- Commit API keys to Git
- Expose API keys in client code

### User Data

- Conversation history is stored locally in the app (not persisted to database)
- User messages are sent to OpenAI for processing
- No personal data should be included in messages

## Next Steps

1. ‚úÖ Deploy Edge Function
2. ‚úÖ Set up OpenAI API key
3. ‚úÖ Test chat functionality
4. üìä Monitor usage and costs
5. üéØ Fine-tune AI prompts based on user feedback
6. üìÅ (Optional) Store chat history in Supabase database

## References

- [OpenAI API Documentation](https://platform.openai.com/docs/api-reference)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [GPT-4 Model Pricing](https://openai.com/pricing)

## Support

If you encounter issues:
1. Check console logs in the app
2. Check Edge Function logs: `supabase functions logs chat`
3. Verify environment variables are set correctly
4. Ensure Edge Function is deployed successfully








