# ğŸ—ï¸ LifeX ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

> Guiding Principleï¼ˆLifex Manifestoï¼‰
> æˆ‘ä»¬çš„æ ¸å¿ƒä»·å€¼æ˜¯åˆ©ç”¨ AI çš„èƒ½åŠ›æ·±å…¥ç†è§£æ¯ä¸ª business å’Œæ¯ä¸ªç”¨æˆ·ï¼Œå¹¶æ®æ­¤åšæœ€åˆé€‚çš„åŒ¹é…ã€‚æ‰€æœ‰å¯ä»¥åˆæ³•è·å–çš„æ•°æ®éƒ½ç”¨äºå¸®åŠ© AI æŒç»­åŠ æ·±ç†è§£ï¼›éšç€æ—¶é—´ä¸æ•°æ®å¢é•¿ï¼Œè¿™ä»½ç†è§£ä¼šä¸æ–­è¿›åŒ–ã€‚å”¯æœ‰åŸºäºè¿™ç§ç†è§£ï¼Œæˆ‘ä»¬æ‰èƒ½æä¾›è®©å®¢æˆ·æ»¡æ„çš„ä¸€åˆ‡æœåŠ¡ï¼ˆchatã€æ¨èã€AI åŠ©æ‰‹ï¼‰ä»¥åŠåç»­çš„ä¼˜æƒ åˆ¸ã€è®¢åº§ã€è®¢é¤ã€æœåŠ¡é¢„å®šã€ç¥¨åŠ¡è´­ä¹°ç­‰ä¸‹æ¸¸äº¤æ˜“ã€‚

## ğŸ“‹ ç›®å½•
1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ•°æ®é‡‡é›†ä¸ç®¡ç†](#æ•°æ®é‡‡é›†ä¸ç®¡ç†)
3. [æ•°æ®æ£€ç´¢ä¸ AI å›ç­”](#æ•°æ®æ£€ç´¢ä¸-ai-å›ç­”)
4. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)

---

## ğŸ¯ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LifeX System                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚         â”‚              â”‚         â”‚             â”‚
â”‚  Mobile App â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Supabase   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Data Layer  â”‚
â”‚ (Frontend)  â”‚   API   â”‚   (Backend)  â”‚  Sync   â”‚  (ETL)      â”‚
â”‚             â”‚         â”‚              â”‚         â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                        â”‚                        â”‚
      â”‚                        â”‚                        â”‚
      â†“                        â†“                        â†“
  ç”¨æˆ·äº¤äº’              æ•°æ®å­˜å‚¨/API            æ•°æ®é‡‡é›†/æ›´æ–°
  - æŸ¥çœ‹å•†å®¶            - PostgreSQL              - Google API
  - AI èŠå¤©             - Edge Functions          - å®šæ—¶ä»»åŠ¡
  - æœç´¢/ç­›é€‰           - Auth/Storage            - æ•°æ®æ¸…æ´—
```

---

## ğŸ¤– æ•°æ®é‡‡é›†ä¸ç®¡ç†

### **æ¶æ„åˆ†å±‚ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®ç®¡ç†å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. æ•°æ®æºå±‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ Google Places API                                â”‚  â”‚
â”‚  â”‚  â€¢ Yelp API                                         â”‚  â”‚
â”‚  â”‚  â€¢ Eventbrite API                                   â”‚  â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·ç”Ÿæˆå†…å®¹ (UGC)                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                  â”‚
â”‚  2. é‡‡é›†å±‚ (Data Collector Service)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è¿è¡Œä½ç½®ï¼š                                          â”‚  â”‚
â”‚  â”‚  â€¢ Supabase Edge Functions â­ (æ¨è)                â”‚  â”‚
â”‚  â”‚  â€¢ GitHub Actions                                   â”‚  â”‚
â”‚  â”‚  â€¢ Cloud Functions                                  â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  åŠŸèƒ½ï¼š                                              â”‚  â”‚
â”‚  â”‚  â€¢ å®šæ—¶é‡‡é›† (Cron Jobs)                            â”‚  â”‚
â”‚  â”‚  â€¢ API è°ƒç”¨å’Œé™é€Ÿ                                   â”‚  â”‚
â”‚  â”‚  â€¢ é”™è¯¯å¤„ç†å’Œé‡è¯•                                   â”‚  â”‚
â”‚  â”‚  â€¢ æ•°æ®éªŒè¯                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                  â”‚
â”‚  3. å¤„ç†å±‚ (ETL Pipeline)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ æ•°æ®æ¸…æ´— (å»é‡ã€æ ‡å‡†åŒ–)                          â”‚  â”‚
â”‚  â”‚  â€¢ æ•°æ®è½¬æ¢ (æ ¼å¼ç»Ÿä¸€)                              â”‚  â”‚
â”‚  â”‚  â€¢ æ•°æ®éªŒè¯ (å®Œæ•´æ€§æ£€æŸ¥)                            â”‚  â”‚
â”‚  â”‚  â€¢ å‘é‡ç”Ÿæˆ (AI Embeddings)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                  â”‚
â”‚  4. å­˜å‚¨å±‚ (Supabase PostgreSQL)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Tables:                                            â”‚  â”‚
â”‚  â”‚  â€¢ businesses (å•†å®¶)                                â”‚  â”‚
â”‚  â”‚  â€¢ events (æ´»åŠ¨)                                    â”‚  â”‚
â”‚  â”‚  â€¢ specials (ä¼˜æƒ )                                  â”‚  â”‚
â”‚  â”‚  â€¢ cache_metadata (ç¼“å­˜å…ƒæ•°æ®)                     â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  Indexes:                                           â”‚  â”‚
â”‚  â”‚  â€¢ ç±»åˆ«ç´¢å¼•                                         â”‚  â”‚
â”‚  â”‚  â€¢ è¯„åˆ†ç´¢å¼•                                         â”‚  â”‚
â”‚  â”‚  â€¢ åœ°ç†ä½ç½®ç´¢å¼• (PostGIS)                          â”‚  â”‚
â”‚  â”‚  â€¢ å‘é‡ç´¢å¼• (pgvector)                             â”‚  â”‚
â”‚  â”‚  â€¢ å…¨æ–‡æœç´¢ç´¢å¼• (tsvector)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **æ•°æ®é‡‡é›†æœåŠ¡å®ç° (Supabase Edge Function):**

```typescript
// supabase/functions/data-collector/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  );
  
  console.log('ğŸ¤– Data Collector Started');
  
  try {
    // 1. é‡‡é›†æ–°å•†å®¶
    const newBusinesses = await collectNewBusinesses();
    console.log(`âœ… Collected ${newBusinesses.length} new businesses`);
    
    // 2. æ›´æ–°è¿‡æœŸæ•°æ®
    const updated = await updateExpiredData(supabase);
    console.log(`âœ… Updated ${updated} expired records`);
    
    // 3. ç”Ÿæˆå‘é‡ (AI Embeddings)
    const embedded = await generateEmbeddings(supabase);
    console.log(`âœ… Generated ${embedded} embeddings`);
    
    // 4. æ¸…ç†æ— æ•ˆæ•°æ®
    const cleaned = await cleanupInvalidData(supabase);
    console.log(`âœ… Cleaned ${cleaned} invalid records`);
    
    return new Response(JSON.stringify({
      status: 'success',
      collected: newBusinesses.length,
      updated,
      embedded,
      cleaned
    }), {
      headers: { 'Content-Type': 'application/json' }
    });
    
  } catch (error) {
    console.error('âŒ Error:', error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500
    });
  }
});

// é‡‡é›†æ–°å•†å®¶
async function collectNewBusinesses() {
  const cities = ['Auckland', 'Wellington', 'Christchurch'];
  const categories = ['restaurant', 'cafe', 'bar', 'gym'];
  const businesses = [];
  
  for (const city of cities) {
    for (const category of categories) {
      const results = await googlePlaces.nearbySearch({
        location: getCityCoordinates(city),
        radius: 5000,
        type: category
      });
      
      businesses.push(...results);
      await sleep(200); // é™é€Ÿ
    }
  }
  
  return businesses;
}

// æ›´æ–°è¿‡æœŸæ•°æ®
async function updateExpiredData(supabase: any) {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  
  const { data: expired } = await supabase
    .from('businesses')
    .select('id, google_place_id')
    .lt('cached_at', thirtyDaysAgo.toISOString())
    .limit(100);
  
  let count = 0;
  for (const business of expired) {
    await updateBusinessData(business);
    count++;
    await sleep(100);
  }
  
  return count;
}

// ç”Ÿæˆå‘é‡
async function generateEmbeddings(supabase: any) {
  const { data: businesses } = await supabase
    .from('businesses')
    .select('id, name, description')
    .is('embedding', null)
    .limit(50);
  
  let count = 0;
  for (const business of businesses) {
    const embedding = await openai.embeddings.create({
      model: 'text-embedding-3-small',
      input: `${business.name} ${business.description}`
    });
    
    await supabase
      .from('businesses')
      .update({ embedding: embedding.data[0].embedding })
      .eq('id', business.id);
    
    count++;
  }
  
  return count;
}
```

---

### **è°ƒåº¦é…ç½® (Supabase Cron):**

```sql
-- æ¯å¤©å‡Œæ™¨ 2 ç‚¹é‡‡é›†æ–°æ•°æ®
select cron.schedule(
  'daily-data-collection',
  '0 2 * * *',
  $$
  select net.http_post(
      url:='https://your-project.supabase.co/functions/v1/data-collector',
      headers:='{"Content-Type": "application/json", "Authorization": "Bearer YOUR_KEY"}'::jsonb
  );
  $$
);

-- æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ›´æ–°è¿‡æœŸæ•°æ®
select cron.schedule(
  'daily-cache-update',
  '0 3 * * *',
  $$
  select net.http_post(
      url:='https://your-project.supabase.co/functions/v1/update-expired-cache',
      headers:='{"Content-Type": "application/json", "Authorization": "Bearer YOUR_KEY"}'::jsonb
  );
  $$
);

-- æ¯å‘¨æ—¥å‡Œæ™¨ 4 ç‚¹ç”Ÿæˆå‘é‡
select cron.schedule(
  'weekly-embedding-generation',
  '0 4 * * 0',
  $$
  select net.http_post(
      url:='https://your-project.supabase.co/functions/v1/generate-embeddings',
      headers:='{"Content-Type": "application/json", "Authorization": "Bearer YOUR_KEY"}'::jsonb
  );
  $$
);
```

---

## ğŸ” æ•°æ®æ£€ç´¢ä¸ AI å›ç­”

### **RAG æ¶æ„ (ä½ å·²åœ¨ç”¨):**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RAG (Retrieval-Augmented Generation)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ç”¨æˆ·é—®é¢˜                                                    â”‚
â”‚  â†“                                                          â”‚
â”‚  "æ¨èå¥¥å…‹å…°çš„å¥½åƒçš„æ„å¤§åˆ©é¤å…"                              â”‚
â”‚  â†“                                                          â”‚
â”‚  1. æ„å›¾åˆ†æ (Intent Detection)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ æå–ï¼šlocation = "Auckland"                      â”‚  â”‚
â”‚  â”‚  â€¢ æå–ï¼šcategory = "Italian restaurant"            â”‚  â”‚
â”‚  â”‚  â€¢ æå–ï¼šintent = "recommendation"                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â†“                                                          â”‚
â”‚  2. æ•°æ®æ£€ç´¢ (Retrieval)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ–¹æ¡ˆ A: ä¼ ç»Ÿæœç´¢ (å½“å‰)                            â”‚  â”‚
â”‚  â”‚  SELECT * FROM businesses                           â”‚  â”‚
â”‚  â”‚  WHERE category = 'restaurant'                      â”‚  â”‚
â”‚  â”‚    AND location = 'Auckland'                        â”‚  â”‚
â”‚  â”‚  ORDER BY rating DESC                               â”‚  â”‚
â”‚  â”‚  LIMIT 5;                                           â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  æ–¹æ¡ˆ B: å‘é‡æœç´¢ (ä¼˜åŒ–)                            â”‚  â”‚
â”‚  â”‚  SELECT * FROM match_businesses(                    â”‚  â”‚
â”‚  â”‚    query_embedding: [0.1, 0.3, ...],               â”‚  â”‚
â”‚  â”‚    match_threshold: 0.8,                           â”‚  â”‚
â”‚  â”‚    match_count: 5                                  â”‚  â”‚
â”‚  â”‚  );                                                 â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  ç»“æœï¼š[Restaurant A, Restaurant B, ...]           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â†“                                                          â”‚
â”‚  3. ä¸Šä¸‹æ–‡æ„å»º (Context Building)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  system_prompt = `                                  â”‚  â”‚
â”‚  â”‚  ä½ æ˜¯ LifeX AI åŠ©æ‰‹...                             â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  ç›¸å…³å•†å®¶æ•°æ®ï¼š                                      â”‚  â”‚
â”‚  â”‚  1. Restaurant A                                    â”‚  â”‚
â”‚  â”‚     - åœ°å€ï¼š123 Main St                            â”‚  â”‚
â”‚  â”‚     - è¯„åˆ†ï¼š4.5 â­                                  â”‚  â”‚
â”‚  â”‚     - ç‰¹è‰²ï¼šæ­£å®—æ„å¼æŠ«è¨                            â”‚  â”‚
â”‚  â”‚  2. Restaurant B ...                                â”‚  â”‚
â”‚  â”‚  `;                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â†“                                                          â”‚
â”‚  4. AI ç”Ÿæˆå›ç­” (Generation)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  OpenAI GPT-4o-mini                                 â”‚  â”‚
â”‚  â”‚  â†“                                                   â”‚  â”‚
â”‚  â”‚  "æˆ‘ä¸ºæ‚¨æ¨èä»¥ä¸‹æ„å¤§åˆ©é¤å…ï¼š                        â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  1. **Restaurant A** â­ 4.5                         â”‚  â”‚
â”‚  â”‚     åœ°å€ï¼š123 Main St, Auckland                     â”‚  â”‚
â”‚  â”‚     ç‰¹è‰²ï¼šæ­£å®—çš„æ„å¼æŠ«è¨å’Œæ‰‹å·¥æ„é¢...              â”‚  â”‚
â”‚  â”‚                                                      â”‚  â”‚
â”‚  â”‚  2. **Restaurant B** ..."                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â†“                                                          â”‚
â”‚  è¿”å›ç»™ç”¨æˆ·                                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **ä¼˜åŒ–åçš„ RAG (æœªæ¥):**

```typescript
// supabase/functions/chat-v3-optimized/index.ts

async function handleUserQuery(userMessage: string, context: any) {
  // 1. æ„å›¾åˆ†æ (ä¿æŒä¸å˜)
  const intent = analyzeUserIntent(userMessage);
  
  // 2. å‘é‡æœç´¢ (æ–°å¢)
  const semanticResults = await semanticSearch(userMessage);
  
  // 3. æ··åˆæœç´¢ (æ–°å¢)
  const hybridResults = await hybridSearch({
    semantic: semanticResults,
    filters: intent.filters,
    location: intent.location
  });
  
  // 4. é‡æ’åº (æ–°å¢)
  const rankedResults = await rerank(hybridResults, userMessage);
  
  // 5. ä¸Šä¸‹æ–‡å¢å¼º
  const enrichedContext = await enrichContext(rankedResults);
  
  // 6. AI ç”Ÿæˆ
  const response = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [
      { role: 'system', content: enrichedContext },
      { role: 'user', content: userMessage }
    ]
  });
  
  return response;
}

// è¯­ä¹‰æœç´¢
async function semanticSearch(query: string) {
  // 1. ç”ŸæˆæŸ¥è¯¢å‘é‡
  const embedding = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: query
  });
  
  // 2. å‘é‡æœç´¢
  const { data } = await supabase.rpc('match_businesses', {
    query_embedding: embedding.data[0].embedding,
    match_threshold: 0.7,
    match_count: 20
  });
  
  return data;
}

// æ··åˆæœç´¢ (è¯­ä¹‰ + è¿‡æ»¤)
async function hybridSearch(params: any) {
  let results = params.semantic;
  
  // åº”ç”¨è¿‡æ»¤å™¨
  if (params.filters.category) {
    results = results.filter(r => r.category === params.filters.category);
  }
  
  if (params.filters.minRating) {
    results = results.filter(r => r.rating >= params.filters.minRating);
  }
  
  // åœ°ç†ä½ç½®è¿‡æ»¤
  if (params.location) {
    results = results.filter(r => 
      calculateDistance(r.location, params.location) < 10000
    );
  }
  
  return results;
}

// é‡æ’åº (ç›¸å…³æ€§ + è´¨é‡)
async function rerank(results: any[], query: string) {
  return results
    .map(r => ({
      ...r,
      score: calculateRelevanceScore(r, query)
    }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 5);
}

function calculateRelevanceScore(business: any, query: string) {
  // ç»¼åˆè¯„åˆ†
  return (
    business.similarity * 0.4 +        // è¯­ä¹‰ç›¸ä¼¼åº¦ 40%
    business.rating / 5 * 0.3 +        // è¯„åˆ† 30%
    business.review_count / 1000 * 0.2 + // è¯„è®ºæ•° 20%
    (business.is_verified ? 0.1 : 0)   // è®¤è¯ 10%
  );
}
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### **å‰ç«¯ (Mobile App):**
- React Native
- Expo
- TypeScript
- Supabase Client

### **åç«¯ (Supabase):**
- PostgreSQL (æ•°æ®åº“)
- PostGIS (åœ°ç†ä½ç½®)
- pgvector (å‘é‡æœç´¢)
- Edge Functions (Deno)
- Cron Jobs (è°ƒåº¦)

### **æ•°æ®é‡‡é›†:**
- Google Places API
- Yelp API
- Eventbrite API
- Supabase Edge Functions

### **AI / ML:**
- OpenAI GPT-4o-mini (å¯¹è¯)
- OpenAI Embeddings (å‘é‡)
- RAG æ¶æ„

### **è°ƒåº¦ / è‡ªåŠ¨åŒ–:**
- Supabase Cron
- GitHub Actions (å¤‡é€‰)

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### **å½“å‰æ€§èƒ½ (ä¼ ç»Ÿæœç´¢):**
- å“åº”æ—¶é—´ï¼š50-100ms âš¡
- æŸ¥è¯¢æˆæœ¬ï¼š$0
- å‡†ç¡®ç‡ï¼š85-90%

### **ä¼˜åŒ–å (å‘é‡æœç´¢):**
- å“åº”æ—¶é—´ï¼š100-200ms
- æŸ¥è¯¢æˆæœ¬ï¼š$0.0001/æŸ¥è¯¢
- å‡†ç¡®ç‡ï¼š95-98% âœ…

---

## ğŸš€ å®æ–½è·¯çº¿å›¾

### **Phase 1: åŸºç¡€æ¶æ„ (å·²å®Œæˆ)**
- [x] Supabase æ•°æ®åº“
- [x] åŸºç¡€ RAG (chat-v2)
- [x] Google Places API é›†æˆ

### **Phase 2: æ•°æ®é‡‡é›†è‡ªåŠ¨åŒ– (ä¸‹ä¸€æ­¥)**
- [ ] Edge Function æ•°æ®é‡‡é›†å™¨
- [ ] Cron Job è°ƒåº¦
- [ ] æ•°æ®æ¸…æ´— Pipeline
- [ ] ç¼“å­˜ç®¡ç†

### **Phase 3: æ£€ç´¢ä¼˜åŒ– (æœªæ¥)**
- [ ] å‘é‡ç´¢å¼• (pgvector)
- [ ] è¯­ä¹‰æœç´¢
- [ ] æ··åˆæœç´¢
- [ ] ç»“æœé‡æ’åº

### **Phase 4: AI Agent (è¿œæœŸ)**
- [ ] æ™ºèƒ½æ•°æ®é‡‡é›†å†³ç­–
- [ ] è‡ªé€‚åº”æ›´æ–°ç­–ç•¥
- [ ] å¼‚å¸¸è‡ªåŠ¨å¤„ç†
- [ ] æŒç»­å­¦ä¹ ä¼˜åŒ–

---

## ğŸ’¡ å…³é”®è¦ç‚¹

### **æ•°æ®é‡‡é›†ï¼š**
1. ä½¿ç”¨ Supabase Edge Functions (æ— éœ€é¢å¤–æœåŠ¡å™¨)
2. Cron Jobs è‡ªåŠ¨è°ƒåº¦
3. ä¸å®Œå…¨æ˜¯ AI Agentï¼Œä½†å¯ä»¥è¿›åŒ–

### **æ•°æ®æ£€ç´¢ï¼š**
1. å½“å‰ä½¿ç”¨ä¼ ç»Ÿ SQL æŸ¥è¯¢ (å·²ç»å¾ˆå¥½)
2. æœªæ¥å¯ä»¥å‡çº§åˆ°å‘é‡æœç´¢ (æ›´å‡†ç¡®)
3. RAG æ¶æ„å·²ç»åœ¨ç”¨ (chat-v2)

### **ä¼˜åŠ¿ï¼š**
- âœ… æ— éœ€é¢å¤–æœåŠ¡å™¨
- âœ… æˆæœ¬æä½
- âœ… è‡ªåŠ¨æ‰©å±•
- âœ… æ˜“äºç»´æŠ¤

---

**è¿™æ˜¯ä¸€ä¸ªé«˜å±‚æ¬¡çš„æ¦‚è§ˆï¼Œå…·ä½“å®æ–½æ—¶å†æ·±å…¥æ¯ä¸ªéƒ¨åˆ†ï¼** ğŸ¯

