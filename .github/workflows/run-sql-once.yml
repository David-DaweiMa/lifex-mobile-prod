name: Run SQL (once)

on:
  workflow_dispatch:
    inputs:
      sql_path:
        description: 'Path to SQL file in repo'
        required: true
        default: 'supabase/migrations/20251106_specials_scrape_cache.sql'

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          set -e
          if [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "Missing SUPABASE_DB_PASSWORD secret"; exit 1
          fi
          host=""
          if [ -n "$SUPABASE_URL" ]; then
            host=$(echo "$SUPABASE_URL" | sed -E 's#https?://([^/]+)/?.*#\1#')
          elif [ -n "$SUPABASE_PROJECT_REF" ]; then
            host="${SUPABASE_PROJECT_REF}.supabase.co"
          fi
          if [ -z "$host" ]; then
            echo "Missing SUPABASE_URL or SUPABASE_PROJECT_REF secret"; exit 1
          fi
          echo "PGHOST=$host" >> $GITHUB_ENV
          echo "PGPORT=6543" >> $GITHUB_ENV
          echo "PGUSER=postgres" >> $GITHUB_ENV
          echo "PGDATABASE=postgres" >> $GITHUB_ENV
          echo "PGPASSWORD=$SUPABASE_DB_PASSWORD" >> $GITHUB_ENV

      - name: Run SQL via pooler (psql)
        shell: bash
        run: |
          set -e
          SQL_PATH="${{ github.event.inputs.sql_path }}"
          if [ ! -f "$SQL_PATH" ]; then
            echo "SQL file not found: $SQL_PATH"; exit 1
          fi
          # sslmode=require is mandatory
          psql "host=$PGHOST port=$PGPORT dbname=$PGDATABASE user=$PGUSER sslmode=require" -f "$SQL_PATH"
          echo "Executed: $SQL_PATH"


